name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Configure CMake
        run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DBLURWINDOW_DLL=ON

      - name: Build
        run: cmake --build build --config Release

      - name: Prepare Release Package
        shell: pwsh
        run: |
          mkdir release_pkg/bin -Force
          mkdir release_pkg/lib -Force
          mkdir release_pkg/include/blurwindow -Force
          
          # Copy Binaries
          copy build/Release/blurwindow.dll release_pkg/bin/
          
          # Copy Libs
          copy build/Release/blurwindow.lib release_pkg/lib/
          
          # Copy Headers
          copy include/blurwindow/*.h release_pkg/include/blurwindow/
          
          # Create ZIP
          Compress-Archive -Path release_pkg/* -DestinationPath blurwindow-x64.zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: blurwindow-x64.zip
          generate_release_notes: true
          draft: false
          prerelease: false

      - name: Upload Artifact (Manual/Debug)
        uses: actions/upload-artifact@v4
        if: github.event_name == 'workflow_dispatch' || !startsWith(github.ref, 'refs/tags/')
        with:
          name: blurwindow-x64-artifact
          path: blurwindow-x64.zip
